# Hello User

Welcome to the Hello User project! This service offers a RESTful API that greets users while keeping track of their upcoming birthdays. Powered by Python and the FastAPI framework, the service also leverages Alembic for database migrations, Pydantic for robust data validation, and SQLModel for seamless database operations.

## Features

- **Simple Greeting**: Enter username to get a personalized greeting.
- **Birthday Countdown**: Provides the days left for the user's birthday.
- **Data Validation**: Utilizes FastAPI's request validation to ensure correct input format.
- **Database Integration**: Uses MySQL for persistent data storage.



## How it works

1. The user can make a `GET` request to `/hello/{username}` to get a personalized greeting.
2. To update or add their birthday, the user can make a `PUT` request to `/hello/{username}` with their date of birth in the request body.



For detailed API documentation, navigate to `http://127.0.0.1:8000/docs` and `http://127.0.0.1:8000/redoc` after launching the service.

![api-docs](doc/api-docs.png "API Docs")



## Prerequisites

* Python 3.9
* MySQL
* Docker
* Google Cloud Platform Account (For cloud deployment)

## Repository Structure

This repository is structured as follows:

* **app**: This folder houses the API service's FastAPI-based source code.
  - **tests**: Includes unit tests.
  - **migrations**: Holds Alembic-generated database migration scripts.
* **docker**: Contains the Dockerfile for building both local and production images.
* **iac**: Holds Terraform scripts for deploying to Google Cloud Platform using services like CloudRun, CloudSQL, and Google Cloud Load Balancer.
* **.github/workflows**: Defines GitHub Actions for CI/CD, handling both building and deploying via Google Container Registry and Terraform.

## Local Development Guide

### On Your Host Machine

1. Clone the repository
   ```shell
   $ git clone git@github.com:dhiva/hello-user.git
   ```

2. Create a new virtual environment within the project directory.

   ```shell
   $ cd ./app
   $ python -m venv venv
   ```

3. Activate the virtual environment in the project.

   ```shell
   $ source venv/bin/activate
   ```

4. Install framework dependencies.

   ```shell
   $ pip install -r requirements.txt
   ```

5. Run the web server locally
   ```shell
   $ export DATABASE_URL="mysql+aiomysql://root:password@localhost:3306/testdb"
   # Run the database migration to create application tables in the database
   $ alembic upgrade head 
   # Initiate the webserver with hot reload for local development
   $ uvicorn main:api --reload
   ```

   

### Running in Docker

This project contains docker-compose to enable quick setup of local development environment

1. Build the docker image
   ```shell
   $ docker-compose build
   ```
2. Run the docker stack
   ```shell
   # Run the below command to initiate the containers in detached mode
   $ docker-compose up -d
   # or to view the logs for the service run the following command without the flag
   $ docker-compose up
   ```
3. On the initial run, you need to execute the database migrations script to create the necessary tables in the database.
   ```shell
   $ docker-compose exec fastapi-app alembic upgrade head 
   ```
4. The unit tests for APIs can be run using the following command
   ```shell
   $ docker-compose exec fastapi-app pytest -s -v
   ```

5. When the datamodel is updated, new database migration revisions can be autogenerated using alembic.
   ```shell
   $ docker-compose exec fastapi-app alembic revision --autogenerate -m "revision comment" 
   ```

   

## System Design

![gcp-infra-design](doc/gcp-infra-design.png "GCP System Design")

### Overview

The service employs a robust architecture on Google Cloud Platform, focusing on high availability, security, and scalable deployments.

### Core Components

- **API Service**: The FastAPI-based Hello User Service serves as the primary API interface. It is containerized and deployed on Google Cloud Run for easy scaling and high availability.
- **Backend Storage**: Google CloudSQL serves as the backend relational database for the service, providing persistent storage, backup, and failover capabilities.
- **Load Balancer**: A Google Cloud Load Balancer is used to manage incoming traffic, distribute loads across multiple instances of the service, and provide SSL termination.

### Deployment Workflow

1. **Containerization**: The FastAPI application is containerized using Docker for consistent and isolated runs.
2. **Continuous Deployment**: Upon updates to the Git repository, the Docker image is pushed to Google Container Registry (GCR) and then deployed to Cloud Run instances using Github Actions.
3. **Database Migrations**: Managed through Cloud Run Jobs, ensuring schema consistency with every new release. During each deployment, a new CloudRun Job service is initiated to complete the database migration.
4. **Load Balancing**: Traffic is routed through Google Cloud Load Balancer, which performs health checks and routes traffic to the most suitable instance.
5. **Monitoring and Logging**: Integrated with Google Cloud Monitoring and Logging for real-time analytics and insights.

### Security Measures

- SSL for encrypted data in transit
- IAM roles and permissions to limit database and service access
- Data encryption at rest in CloudSQL

### Deployment Strategy

The service deployment to production can be done through "blue/green" deployment. When a new version of the service is deployed using Terraform, the new revision is configured with no traffic redirection. The new revision can be tested using the revision specific URL without the need to migrate user traffic to it.

After running automated and manual tests on the service. Traffic can be migrated gradually to the new revision
```shell
$ gcloud beta run services update-traffic hello-user-service --to-tags green=1
```

The above command redirects 1% of traffic to the new revision. The traffic can be gradually increased by running the above command with increasing the traffic percentage.

In case of issues, the code can be easily rolled back to previous revision using
```shell
$ gcloud beta run services update-traffic hello-user-service --to-revisions hello-user-service-0001=100
```



### Future Considerations

* Enable autoscaling for the Cloud Run and CloudSQL services to handle varying workloads.
* Improved Github Actions to automate terraform deployment.
* CI/CD for automated testing and Blue/Green rollouts.